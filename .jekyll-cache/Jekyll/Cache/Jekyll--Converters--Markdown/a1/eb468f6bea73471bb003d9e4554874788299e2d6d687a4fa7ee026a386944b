I"¨J<h3 id="ä¸€-æ­¥éª¤">ä¸€ã€ æ­¥éª¤</h3>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">1</span><span class="p">.</span> <span class="nf">rm</span> <span class="no">Gemfile</span><span class="p">.</span><span class="nf">lock</span>
<span class="mi">2</span><span class="p">.</span> <span class="nf">bundle</span> <span class="n">update</span>
<span class="mi">3</span><span class="p">.</span> <span class="nf">rails</span> <span class="n">app</span><span class="ss">:update</span>
</code></pre></div></div>

<h3 id="äºŒ-è¯´æ˜">äºŒã€ è¯´æ˜</h3>

<h4 id="1-dockerfile">1. dockerfile</h4>
<p>ç¬¬ä¸€æ­¥æ„å»ºï¼Œéœ€è¦ä¸‹è½½å®‰è£… oracleï¼Œ åç»­åœ¨ç¬¬ä¸€æ­¥é•œåƒä¸Šæ„å»º</p>

<p>dockerfile å¦‚ä¸‹ï¼š</p>
<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> ruby:2.7.2</span>
<span class="k">ENV</span><span class="s"> RAILS_ROOT /var/www/research</span>
<span class="k">ENV</span><span class="s"> port 3000</span>
<span class="k">ENV</span><span class="s"> RAILS_ENV production</span>
<span class="k">ENV</span><span class="s"> LD_LIBRARY_PATH=/opt/oracle/instantclient_11_2</span>
<span class="k">EXPOSE</span><span class="s"> $port:$port/tcp</span>
<span class="k">WORKDIR</span><span class="s"> $RAILS_ROOT</span>

<span class="k">RUN </span><span class="nb">cd</span> / <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-rf</span> <span class="nv">$RAILS_ROOT</span>

<span class="k">COPY</span><span class="s"> . .</span>

<span class="k">RUN </span><span class="nb">mv </span>vendor/sources.list /etc/apt/sources.list <span class="o">&amp;&amp;</span> <span class="se">\
</span>    apt-get update <span class="o">&amp;&amp;</span>     apt-get <span class="nb">install</span> <span class="nt">-y</span>  libpq-dev libaio1 <span class="o">&amp;&amp;</span><span class="se">\
</span>    <span class="nb">cd</span> /opt <span class="o">&amp;&amp;</span> curl <span class="nt">-O</span> http://rccdevops.oss-cn-hangzhou.aliyuncs.com/oracle.zip <span class="o">&amp;&amp;</span> unzip oracle.zip <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-rf</span> oracle.zip <span class="o">&amp;&amp;</span><span class="se">\
</span>    <span class="nb">cp</span> /usr/share/zoneinfo/Asia/Shanghai  /etc/localtime <span class="o">&amp;&amp;</span><span class="se">\
</span>    curl <span class="nt">-O</span> http://rccdevops.oss-cn-hangzhou.aliyuncs.com/utils/rcc-confd <span class="o">&amp;&amp;</span><span class="se">\
</span>    <span class="nb">chmod</span> +x rcc-confd <span class="o">&amp;&amp;</span><span class="se">\
</span>    <span class="nb">cp</span> /usr/share/zoneinfo/Asia/Shanghai  /etc/localtime <span class="o">&amp;&amp;</span><span class="se">\
</span>    <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$RAILS_ROOT</span>/tmp/pids/ <span class="o">&amp;&amp;</span><span class="se">\
</span>    <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$RAILS_ROOT</span>/tmp/sockets/ <span class="o">&amp;&amp;</span><span class="se">\
</span>    <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$RAILS_ROOT</span>/log <span class="o">&amp;&amp;</span><span class="se">\
</span>    bundle 
<span class="k">CMD</span><span class="s"> ./rcc-confd</span>
</code></pre></div></div>

<h4 id="2-deploymentyml">2. deployment.yml</h4>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Could</span> <span class="n">not</span> <span class="n">find</span> <span class="n">rake</span>
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gems å®‰è£…åˆ° /usr/local/bundle/gems ä¸‹
pod é‡Œå–çš„æ˜¯ /usr/local/bundle/ruby/2.7.2/gems ä¸‹çš„ gems

è¿™æ˜¯ ruby ç‰ˆæœ¬å‡çº§å’Œ bundle çš„åŸå› 
https://github.com/docker-library/ruby/pull/306

åˆ é™¤ BUNDLE_PATH,
æ·»åŠ  GEM_PATH  /usr/local/bundle

```yaml
apiVersion: apps/v1beta2
kind: Deployment
metadata:
  labels:
    app: research
  name: research
spec:
  progressDeadlineSeconds: 600
  replicas: POD_REPLICAS
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: research
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: research
    spec:
      containers:
        - env:
            - name: LANG
              value: C.UTF-8
            - name: RUBY_MAJOR
              value: '2.7'
            - name: RUBY_DOWNLOAD_SHA256
              value: 9bf6370aaa82c284f193264cc7ca56f202171c32367deceb3599a4f354175d7d
            - name: GEM_HOME
              value: /usr/local/bundle
            - name: GEM_PATH
              value: /usr/local/bundle
            - name: BUNDLE_SILENCE_ROOT_WARNING
              value: '1'
            - name: BUNDLE_APP_CONFIG
              value: /usr/local/bundle
            - name: RAILS_ROOT
              value: /var/www/research
            - name: LD_LIBRARY_PATH
              value: /opt/oracle/instantclient_11_2
            - name: port
              value: '3000'
            - name: RAILS_ENV
              value: production
            - name: CONFD_ENV
              valueFrom:
                configMapKeyRef:
                  key: CONFD_ENV
                  name: resource
            - name: CONFD_RUN
              value: puma -C config/puma.rb
            - name: aliyun_logs_research
              value: /var/www/research/log/*.log
          securityContext:
            privileged: true
          image: 'registry-vpc.cn-hangzhou.aliyuncs.com/rcc_image/research:IMAGE_TAG'
          imagePullPolicy: Always
          name: research
          resources:
            limits:         #æœ€é«˜è¿è¡Œé™åˆ¶
              cpu: 500m   #å®¹å™¨å¯åŠ¨åæœ€å¤šå¯ç”¨CPUæ ¸æ•°ã€‚
              memory: 3000Mi  #å®¹å™¨å¯åŠ¨æœ€å¤šå¯ç”¨å†…å­˜æ•° å•ä½MiBã€GiB
            requests:       #æœ€ä½å¯åŠ¨é™åˆ¶è®¾ç½®
              cpu: 100m  #æœ€ä½å®¹å™¨å¯åŠ¨å¯ç”¨CPUæ ¸æ•°ã€‚
              memory: 2244Mi  #æœ€ä½å®¹å™¨å¯åŠ¨å¯ç”¨å†…å­˜æ•° å•ä½MiBã€GiB
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
            - mountPath: /var/www/research/public/download
              name: volume-pangu-download
            - mountPath: /var/www/research/public/files
              name: volume-reach-files
      dnsPolicy: ClusterFirst
      imagePullSecrets:
        - name: dev
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30
      nodeSelector:
        group: oms
      volumes:
        - name: volume-pangu-download
          persistentVolumeClaim:
            claimName: pangu-download
        - name: volume-reach-files
          persistentVolumeClaim:
            claimName: reach-files

</code></pre></div></div>

<ol>
  <li>undefined Rack::Protection
    <div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mf">6.1</span><span class="o">.</span><span class="mi">0</span>
<span class="no">Web</span> <span class="no">UI</span> <span class="o">-</span> <span class="no">Dark</span> <span class="no">Mode</span> <span class="n">fixes</span> <span class="p">[</span><span class="c1">#4543, natematykiewicz]</span>
<span class="no">Ensure</span> <span class="no">Rack</span><span class="o">::</span><span class="no">ContentLength</span> <span class="n">is</span> <span class="n">loaded</span> <span class="n">as</span> <span class="n">middleware</span> <span class="k">for</span> <span class="n">correct</span> <span class="no">Web</span> <span class="no">UI</span> <span class="n">responses</span> <span class="p">[</span><span class="c1">#4541]</span>
<span class="no">Avoid</span> <span class="n">exception</span> <span class="n">dumping</span> <span class="no">SSL</span> <span class="n">store</span> <span class="k">in</span> <span class="no">Redis</span> <span class="n">connection</span> <span class="n">logging</span> <span class="p">[</span><span class="c1">#4532]</span>
<span class="no">Better</span> <span class="n">error</span> <span class="n">messages</span> <span class="k">in</span> <span class="no">Sidekiq</span><span class="o">::</span><span class="no">Client</span> <span class="p">[</span><span class="c1">#4549]</span>
<span class="o">**</span><span class="no">Remove</span> <span class="n">rack</span><span class="o">-</span><span class="n">protection</span><span class="p">,</span> <span class="n">reimplement</span> <span class="no">CSRF</span> <span class="n">protection</span> <span class="p">[</span><span class="c1">#4588]**</span>
<span class="no">Require</span> <span class="n">redis</span><span class="o">-</span><span class="n">rb</span> <span class="mf">4.2</span> <span class="p">[</span><span class="c1">#4591]</span>
<span class="no">Update</span> <span class="n">to</span> <span class="n">jquery</span> <span class="mf">1.12</span><span class="o">.</span><span class="mi">4</span> <span class="p">[</span><span class="c1">#4593]</span>
<span class="no">Refactor</span> <span class="n">internal</span> <span class="n">fetch</span> <span class="n">logic</span> <span class="n">and</span> <span class="no">API</span> <span class="p">[</span><span class="c1">#4602]</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>æ³¨é‡Šå¦‚ä¸‹é…ç½®ï¼š</p>
<h1 id="sidekiqwebclass_eval-do">Sidekiq::Web.class_eval do</h1>
<h1 id="use-rackprotection-origin_whitelist-httpresearchrccchinacom-httpsresearchrccchinacom--resolve-rack-protection-httporigin">use Rack::Protection, origin_whitelist: [â€˜http://research.rccchina.comâ€™, â€˜https://research.rccchina.comâ€™] # resolve Rack Protection HttpOrigin</h1>
<h1 id="end-if-railsenvproduction">end if Rails.env.production?</h1>

<ol>
  <li>ActiveRecord::UnknownAttributeReference
    <div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">UnknownAttributeReference</span> <span class="p">(</span><span class="no">Query</span> <span class="nb">method</span> <span class="n">called</span> <span class="n">with</span> <span class="n">non</span><span class="o">-</span><span class="n">attribute</span> <span class="n">argument</span><span class="p">(</span><span class="n">s</span><span class="p">):</span> <span class="s2">"projects.urgent desc, projects.reject, project_messages.submit_at "</span><span class="p">):</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>order_sql = â€˜projects.urgent desc, projects.reject, project_messages.submit_at â€˜
å› ä¸º order åé¢çš„å‚æ•°å‰åä¸èƒ½æœ‰ç©ºæ ¼, ä¹Ÿä¸èƒ½ç”¨å‡½æ•°ï¼Œæ¯”å¦‚ <code class="highlighter-rouge">NVL(projects.urgent, 0) desc</code></p>

<p>å»é™¤å‰åç©ºæ ¼ï¼Œå‡½æ•°ä½¿ç”¨ï¼Œç”¨ Arel.sql(â€˜NVL(projects.urgent, 0) descâ€™)</p>

<p>order(Arel.sql(â€˜NVL(projects.urgent, 0) descâ€™))</p>

<ol>
  <li>update_attributes
    <div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">remark</span> <span class="o">=</span> <span class="no">ReachRemark</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">remark_type: </span><span class="n">obj_type</span><span class="p">,</span> <span class="ss">type_id: </span><span class="n">obj_id</span><span class="p">).</span><span class="nf">last</span>
<span class="n">remark</span> <span class="o">||=</span> <span class="no">ReachRemark</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">remark_type: </span><span class="n">obj_type</span><span class="p">,</span> <span class="ss">type_id: </span><span class="n">obj_id</span><span class="p">)</span>
<span class="k">if</span> <span class="n">remark</span><span class="p">.</span><span class="nf">update_attributes</span><span class="p">(</span><span class="ss">remark: </span><span class="n">remarks</span><span class="p">)</span>
  <span class="n">remark</span><span class="p">.</span><span class="nf">remark</span>
<span class="k">else</span>
  <span class="n">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:remarks</span><span class="p">,</span> <span class="ss">:invalid</span><span class="p">,</span> <span class="ss">message: </span><span class="s1">'ä¿å­˜å¤±è´¥'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>    </div>
  </li>
</ol>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">NoMethodError</span> <span class="p">(</span><span class="n">undefined</span> <span class="nb">method</span> <span class="sb">`update_attributes' for #&lt;ReachRemark:0x00007fc79db87e70&gt;
Did you mean?  update_attribute):
</span></code></pre></div></div>
<div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Remove deprecated <span class="sb">`ActiveRecord::Base#update_attributes`</span> and <span class="sb">`ActiveRecord::Base#update_attributes!`</span>.
</code></pre></div></div>
<p>å…¨éƒ¨æ”¹ä¸º update</p>

<ol>
  <li>grape
    <div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">undefined</span> <span class="nb">method</span> <span class="n">translate_attribute</span> <span class="k">for</span> <span class="c1">#&lt;Grape::Exceptions::ValidationErrors:0xxxxx&gt;</span>
</code></pre></div>    </div>
    <p>translate_attribute å·²ç»åˆ é™¤ï¼Œ åªæœ‰ translate_attributes</p>
  </li>
  <li>ActiveModel
    <div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># FrozenError: can't modify frozen Hash: {}</span>
<span class="n">errors</span><span class="p">.</span><span class="nf">details</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="kp">attr</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">)</span> <span class="c1"># è¿™è¡ŒæŠ¥é”™</span>
</code></pre></div>    </div>
    <p>åŸå› æ˜¯</p>
    <div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">errors</span><span class="p">.</span><span class="nf">details</span><span class="p">.</span><span class="nf">freeze</span> <span class="c1"># ä¸èƒ½è¢«ä¿®æ”¹</span>
</code></pre></div>    </div>
    <p>æºä»£ç å¦‚ä¸‹ï¼š</p>
    <div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">ActiveModel</span>
  <span class="k">class</span> <span class="nc">Errors</span>
 <span class="k">class</span> <span class="nc">DeprecationHandlingDetailsHash</span> <span class="o">&lt;</span> <span class="no">SimpleDelegator</span>
   <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>
     <span class="n">details</span><span class="p">.</span><span class="nf">default</span> <span class="o">=</span> <span class="p">[]</span>
     <span class="n">details</span><span class="p">.</span><span class="nf">freeze</span>
     <span class="k">super</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>
   <span class="k">end</span>
 <span class="k">end</span>

 <span class="k">def</span> <span class="nf">details</span>
   <span class="nb">hash</span> <span class="o">=</span> <span class="n">group_by_attribute</span><span class="p">.</span><span class="nf">transform_values</span> <span class="k">do</span> <span class="o">|</span><span class="n">errors</span><span class="o">|</span>
     <span class="n">errors</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:details</span><span class="p">)</span>
   <span class="k">end</span>
   <span class="no">DeprecationHandlingDetailsHash</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nb">hash</span><span class="p">)</span>
 <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>å‚è€ƒï¼šhttps://github.com/rails/rails/blob/6-1-stable/activemodel/CHANGELOG.md</p>

<ol>
  <li>utf-8
    <div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">StatementInvalid</span><span class="p">:</span> <span class="no">Encoding</span><span class="o">::</span><span class="no">UndefinedConversionError</span><span class="p">:</span> <span class="s2">"</span><span class="se">\xE5</span><span class="s2">"</span> <span class="n">from</span> <span class="no">ASCII</span><span class="o">-</span><span class="mi">8</span><span class="no">BIT</span> <span class="n">to</span> <span class="no">UTF</span><span class="o">-</span><span class="mi">8</span>
</code></pre></div>    </div>
    <p>å¯¼å…¥æ–‡ä»¶ï¼Œæ–‡ä»¶åå­—
```rb
â€œ\xE5\xBC\x80\xE5\x8F\x91\xE5\x95\x86\xE5\xAE\xA2\xE6\x88\xB7\xE8\xB5\x84\xE6\xBA\x90\xE4\xB8\x8A\xE4\xBC\xA0_20210105115722.xlsxâ€</p>
  </li>
</ol>

<h1 id="ä½¿ç”¨-force_encodingutf-8-æ–¹æ³•">ä½¿ç”¨ force_encoding(â€˜utf-8â€™) æ–¹æ³•</h1>
<p>```
è½¬ä¸º â€œå¼€å‘å•†å®¢æˆ·èµ„æºä¸Šä¼ _20210105115722.xlsxâ€</p>

<p>@shawn.han @jesse.tang @connor.qu
Rails 6.1 å‡çº§é¡»çŸ¥ï¼š</p>
<ol>
  <li>update_attributes å’Œ update_attributes! è¿™ä¸ªæ–¹æ³•ä¸èƒ½ç”¨äº†
Remove deprecated <code class="highlighter-rouge">ActiveRecord::Base#update_attributes</code> and <code class="highlighter-rouge">ActiveRecord::Base#update_attributes!</code>.
å…·ä½“æ–‡æ¡£ï¼šhttps://github.com/rails/rails/blob/6-1-stable/activerecord/CHANGELOG.md</li>
  <li>order sql å‰åä¸å…è®¸æœ‰ç©ºæ ¼ï¼Œ ä¹Ÿä¸å…è®¸ç›´æ¥å†™å‡½æ•°
æ¯”å¦‚ï¼š
a. Project.order(â€˜created_at desc â€˜) // Error
b. Project.order(â€˜ created_at descâ€™) // Error
c. Project.order(â€˜created_at descâ€™) // success
d. Project.order(Arel.sql(â€˜ created_at desc â€˜)) // success</li>
</ol>

<p>e. Project.order(â€˜NVL(projects.urgent, 0) descâ€™) // Error
f. Project.order(Arel.sql(â€˜NVL(projects.urgent, 0) descâ€™)) // success</p>

<p>æ¨èä½¿ç”¨ï¼šProject.order(created_at: :desc, updated_at: :desc) çš„å½¢å¼
å¦‚æœéè¦åµŒå…¥å­—ç¬¦ä¸²ï¼Œå¯ä»¥ä½¿ç”¨ Arel.sql() åŒ…è£…ä¸€ä¸‹ï¼Œç”¨ Arel.sql, Rails å°±è®¤ä¸ºä½ è¿™ä¸ªå­—ç¬¦ä¸²æ˜¯å®‰å…¨çš„ï¼Œå¹¶ä¸ä¼šåš Rails å®‰å…¨æ£€æŸ¥, å¿…é¡»æ ¼å¤–å°å¿ƒä½¿ç”¨</p>

<p>å…·ä½“æ–‡æ¡£ï¼šhttps://github.com/rails/rails/blob/master/activerecord/lib/arel.rb</p>

<p>é—ç•™é—®é¢˜ï¼š</p>
<ol>
  <li>scope</li>
  <li>where.not</li>
  <li>canâ€™t modify frozen attributes
  ActiveRecord::Base.has_many_inversing = true</li>
</ol>
:ET